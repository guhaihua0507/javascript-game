<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hua rong dao</title>
<style type="text/css">
.mainboard {
	position: relative;
	width: 400px;
	height: 500px;
	border: 5px solid #777777;
	margin-left: auto;
	margin-right: auto;
	background-color: #BCB;
	/*shadow effect*/
	-moz-box-shadow: 10px 10px 20px #888888;;
    -webkit-box-shadow: 10px 10px 20px #888888;
    box-shadow: 10px 10px 20px #888888; 
}

.block {
	position: absolute;
	background-attachment: scroll;
	background-clip: border-box;
	background-color: #CCC;
	border-left: 1px solid white;
	border-right:1px solid black;
	border-top: 1px solid white;
	border-bottom: 1px solid black;
	cursor: pointer;
}
.block:hover {
	background-color: #EEEEEE;
}

.console {
	position: relative;
	width: 400px;
	height: 200px;
	border: 1px solid #777777;
	overflow: scroll;
}

</style>
<script type="text/javascript">
	var GameUI = function(id) {
		this.ui = document.getElementById(id);
		this.width = null;
		this.height = null;
		this.initialize();
	}
	
	GameUI.prototype = {
		initialize: function() {
			this.width = this.ui.clientWidth;
			this.height = this.ui.clientHeight;
		},
		
		show: function(el, x, y) {
			if (!this.ui.contains(el)) {
				this.ui.appendChild(el);
			}
			el.style.left = x + "px";
			el.style.top = y + "px";
		}
	}
	
	/*
	 * w-block width, h-block height, x,y-block position in game coordinate
	 * px-cell width
	 */
	var Block = function(w, h, x, y, game) {
		this.w = w;
		this.h = h;
		this.x = x;
		this.y = y;
		this.cell = [];
		this.ui = null;

		this.game = game;
		this.px = game.PIX;
		
		this.initialize();
	}
	Block.prototype = {
		initialize: function() {
			this.ui = document.createElement('div');
			this.ui.className = 'block';
			this.ui.style.width = (this.px * this.w - 2) + "px";
			this.ui.style.height = (this.px * this.h - 2) + "px";
			this.ui.blockObj = this;
			this.refresh();
			//this.loadControl();
		},
		
		refresh: function() {
			for (var i = 0; i < this.h; i++) {
				this.cell[i] = [];
				for (var j = 0; j < this.w; j++) {
					var posX = this.x + j;
					var posY = this.y + i;
					this.cell[i][j] = {x : posX, y : posY};
				}
			}
		},
		
		move: function(x, y) {
			this.x = x;
			this.y = y;
			this.refresh();
		},
		
		loadControl: function() {
			var dragobj = this.ui;
			var block = this;
			this.ui.onmousedown = function(event) {
				if (block.game.moveOff) {
					return;
				}
				dragobj.readyDrag = false;
				var boundaries = [];
				var offsetLeft = dragobj.offsetLeft;
				var offsetTop = dragobj.offsetTop;
				if (block.game.movable(block, 0)) {
					boundaries.push({
						direct: 0,
						vertical: dragobj.offsetTop - block.px,
						horizontal: 0
					});
				}
				if (block.game.movable(block, 1)) {
					boundaries.push({
						direct: 1,
						vertical: 0,
						horizontal: dragobj.offsetLeft + block.px
					});
				}
				if (block.game.movable(block, 2)) {
					boundaries.push({
						direct: 2,
						vertical: dragobj.offsetTop + block.px,
						horizontal: 0
					});
				}
				if (block.game.movable(block, 3)) {
					boundaries.push({
						direct: 3,
						vertical: 0,
						horizontal: dragobj.offsetLeft - block.px
					});
				}
				
				if (boundaries.length == 0) {
					dragobj.readyDrag = false;
				} else {
					dragobj.readyDrag = true;
				}
				
				if (!dragobj.readyDrag) {
					return;
				}
				dragobj.boundaries = boundaries;
				dragobj.startMouseX = event.clientX;
				dragobj.startMouseY = event.clientY;
				dragobj.startX = dragobj.offsetLeft;
				dragobj.startY = dragobj.offsetTop;
			};
			
			this.ui.onmousemove = function(event) {
				if (!dragobj.readyDrag) {
					return;
				}
				var offsetStartX = event.clientX - dragobj.startMouseX;
				var offsetStartY = event.clientY - dragobj.startMouseY;
				var direct = -1;
				var posX = dragobj.startX;
				var posY = dragobj.startY;
				if (Math.abs(offsetStartX) >= Math.abs(offsetStartY)) {
					if (offsetStartX < 0) {
						direct = 3;	//left
					} else if (offsetStartX > 0) {
						direct = 1;	//right
					}
					posX = posX + offsetStartX;
				} else {
					if (offsetStartY < 0) {
						direct = 0;	//up
					} else if (offsetStartY > 0) {
						direct = 2;
					}
					posY = posY + offsetStartY;
				}
				
				var boundaries = dragobj.boundaries;
				var boundary = null;
				for (var i = 0; i < boundaries.length; i++) {
					if (boundaries[i].direct == direct) {
						boundary = boundaries[i];
					}
				}
				if (boundary == null) {
					return;
				}
				
				debug("boundary:" + boundary.vertical + "," + boundary.horizontal + ",direct:" + direct);
				debug("pos:left:" + dragobj.startX + ", top:" + dragobj.startY);
				debug("toX:" + posX + ", toY:" + posY);
				
				if (direct == 0) {
					dragobj.style.top = Math.max(posY, boundary.vertical) + "px";
					dragobj.moveDirect = {x:0, y:-1};
				} else if (direct == 1) {
					dragobj.style.left = Math.min(posX, boundary.horizontal) + "px";
					dragobj.moveDirect = {x:1, y:0};
				} else if (direct == 2) {
					dragobj.style.top = Math.min(posY, boundary.vertical) + "px";
					dragobj.moveDirect = {x:0, y:1};
				} else if (direct == 3) {
					dragobj.style.left = Math.max(posX, boundary.horizontal) + "px";
					dragobj.moveDirect = {x:-1, y:0};
				}
			};
			
			this.ui.onmouseup = function(event) {
				if (!dragobj.readyDrag) {
					return;
				}
				
				if (dragobj.moveDirect) {
					block.game.moveBlock(block, block.x + dragobj.moveDirect.x, block.y + dragobj.moveDirect.y);
				}
				
				dragobj.readyDrag = false;
				dragobj.moveDirect = null;
			};
			//TODO untested
			this.ui.onmouseout = function(event) {
				if (!dragobj.readyDrag) {
					return;
				}
				dragobj.readyDrag = false;
				dragobj.moveDirect = null;
				block.game.showBlock(block);
			}
		}
	}
	
	var Game = function(id) {
		this.WIDTH = 4;
		this.HEIGHT = 5;
		this.PIX = 100;
		
		this.gameUI = new GameUI(id);
		this.cells = [];
		this.blocks = [];
		this.moveOff = false;
		
		this.history = [];
		
		this.initialize();
	}
	
	Game.prototype = {
		initialize: function() {
			this.initCells();
			this.initBlocks();
			this.showBlocks();
			this.setupControl();
		},
		
		initCells: function() {
			for (var i = 0; i < this.HEIGHT; i++) {
				this.cells[i] = [];
				for (var j = 0; j < this.WIDTH; j++) {
					this.cells[i][j] = 0;
				}
			}
		},
		
		initBlocks: function() {
			this.blocks.length = 0;
			this.blocks.push(new Block(2, 2, 1, 0, this));		//cao cao
			this.blocks.push(new Block(1, 2, 0, 0, this));
			this.blocks.push(new Block(1, 2, 3, 0, this));
			this.blocks.push(new Block(1, 2, 0, 2, this));
			this.blocks.push(new Block(2, 1, 1, 2, this));
			this.blocks.push(new Block(1, 1, 1, 3, this));
			this.blocks.push(new Block(1, 1, 2, 3, this));
			this.blocks.push(new Block(1, 2, 3, 2, this));
			this.blocks.push(new Block(1, 1, 0, 4, this));
			this.blocks.push(new Block(1, 1, 3, 4, this));
		},
		
		showBlocks: function() {
			for (var i = 0; i < this.blocks.length; i++) {
				this.showBlock(this.blocks[i]);
				this.updateCell(this.blocks[i], true);
			}
		},
		
		showBlock: function(block) {
			var pos = this.mapUIPosition(block.x, block.y);
			this.gameUI.show(block.ui, pos.x, pos.y);
		},
		
		mapUIPosition: function(x, y) {
			return {x: this.PIX * x, y: this.PIX * y};
		},
		
		moveBlock: function(block, x, y) {
			this.updateCell(block, false);
			block.move(x, y);
			this.showBlock(block);
			this.updateCell(block, true);
		},
		
		updateCell: function(block, b) {
			for (var i = 0; i < block.cell.length; i++) {
				for (var j = 0; j < block.cell[i].length; j++) {
					var bc = block.cell[i][j];
					this.cells[bc.y][bc.x] = b ? 1 : 0;
				}
			}
		},
		
		/*d - direct, 0-up, 1-right, 2-down, 3-left*/
		movable: function(block, d) {
			var b = true;
			if (d == 0) {
				for (var i = 0; i < block.cell[0].length; i++) {
					var c = block.cell[0][i];
					if (c.y == 0 || this.cells[c.y - 1][c.x] == 1) {
						b = false;
						break;
					}
				}
			} else if (d == 1) {
				var lastIndex = block.cell[0].length - 1;
				for (var i = 0; i < block.cell.length; i++) {
					var c = block.cell[i][lastIndex];
					if (c.x == this.WIDTH - 1 || this.cells[c.y][c.x + 1] == 1) {
						b = false;
						break;
					}
				}
			} else if (d == 2) {
				var lastIndex = block.cell.length - 1;
				for (var i = 0; i < block.cell[lastIndex].length; i++) {
					var c = block.cell[lastIndex][i];
					if (c.y == this.HEIGHT - 1 || this.cells[c.y + 1][c.x] == 1) {
						b = false;
						break;
					}
				}
			} else if (d == 3) {
				for (var i = 0; i < block.cell.length; i++) {
					var c = block.cell[i][0];
					if (c.x == 0 || this.cells[c.y][c.x - 1] == 1) {
						b = false;
						break;
					}
				}
			} else {
				b = false;
			}
			return b;
		},
		
		setupControl: function() {
			var game = this;
			this.addEventListener('mousedown', function(event) {
				if (game.moveOff) {
					return;
				}
				var uiElement = event.srcElement;
				var moveBlock = uiElement.blockObj;
				if (!moveBlock) {
					return;
				}
				game.blockStartMoving(moveBlock, event);
				if (uiElement.readyMoving) {
					game.capturedBlock = moveBlock;
					if (uiElement.setCapture) {
						uiElement.setCapture();
					}
				}
			});
			
			this.addEventListener('mousemove', function(event) {
				if (game.moveOff) {
					return;
				}
				if (!game.capturedBlock) {
					return;
				}
				if (!game.capturedBlock.ui.readyMoving) {
					return;
				}
				game.blockOnMoving(game.capturedBlock, event);
			});
			
			this.addEventListener('mouseup', function(event) {
				if (game.moveOff) {
					return;
				}
				var moveBlock = game.capturedBlock;
				if (!moveBlock) {
					return;
				}
				if (!moveBlock.ui.readyMoving) {
					return;
				}
				game.blockEndMoving(moveBlock, event);
				if (moveBlock.ui.releaseCapture) {
					moveBlock.ui.releaseCapture();
				}
				moveBlock.ui.readyMoving = false;
				game.capturedBlock = null;
			});
		},
		
		addEventListener: function(e, call) {
			if (window.addEventListener) {			//chrome, firefox
				window.addEventListener(e, call);
			} else if (document.attachEvent) {		//IE7, IE8, IE9
				document.attachEvent('on' + e, call);	
			}
		},
		
		blockStartMoving: function(block, e) {
			var uiElement = block.ui;
			uiElement.startPos = {x:uiElement.offsetLeft, y:uiElement.offsetTop};
			uiElement.mousePos = {x:e.clientX, y:e.clientY};
			//TODO fix me
			uiElement.readyMoving = true;
		},
		
		blockOnMoving: function(block, e) {
			var uiElement = block.ui;
			var offsetX = e.clientX - uiElement.mousePos.x;
			var offsetY = e.clientY - uiElement.mousePos.y;
			uiElement.style.left = uiElement.startPos.x + offsetX + 'px';
			uiElement.style.top = uiElement.startPos.y + offsetY + 'px';
		},
		
		blockEndMoving: function(block, e) {
			var uiElement = block.ui;
			uiElement.mousePos = undefined;
			uiElement.startPos = undefined;
		}
	}
	
	window.onload = function() {
		var game = new Game('main');
	}
	
	function debug(msg) {
		var consol = document.getElementById('console');
		consol.innerHTML = consol.innerHTML + "<br>" + msg;
	} 
</script>
</head>
<body>
	<div id="main" class="mainboard"></div>
	<div id='console' class="console"></div>
</body>
</html>