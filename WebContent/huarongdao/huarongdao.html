<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hua rong dao</title>
<style type="text/css">
.mainboard {
	position: relative;
	width: 400px;
	height: 500px;
	border: 5px solid #777777;
	margin-left: auto;
	margin-right: auto;
	background-color: #BCB;
	/*shadow effect*/
	-moz-box-shadow: 10px 10px 20px #888888;;
    -webkit-box-shadow: 10px 10px 20px #888888;
    box-shadow: 10px 10px 20px #888888; 
}

.block {
	position: absolute;
	background-attachment: scroll;
	background-clip: border-box;
	background-color: #CCC;
	border-left: 1px solid white;
	border-right:1px solid black;
	border-top: 1px solid white;
	border-bottom: 1px solid black;
}
.block:hover {
	cursor: pointer;
	background-color: #EEEEEE;
}

</style>
<script type="text/javascript">
	var GameUI = function(id) {
		this.ui = document.getElementById(id);
		this.width = null;
		this.height = null;
		this.initialize();
	}
	
	GameUI.prototype = {
		initialize: function() {
			this.width = this.ui.clientWidth;
			this.height = this.ui.clientHeight;
		},
		
		show: function(el, x, y) {
			if (!this.ui.contains(el)) {
				this.ui.appendChild(el);
			}
			el.style.left = x + "px";
			el.style.top = y + "px";
		}
	}
	
	/*
	 * w-block width, h-block height, x,y-block position in game coordinate
	 * px-cell width
	 */
	var Block = function(w, h, x, y, game) {
		this.w = w;
		this.h = h;
		this.x = x;
		this.y = y;
		this.cell = [];
		this.ui = null;

		this.game = game;
		this.px = game.PIX;
		
		this.initialize();
	}
	Block.prototype = {
		initialize: function() {
			this.ui = document.createElement('div');
			this.ui.className = 'block';
			this.ui.style.width = (this.px * this.w - 2) + "px";
			this.ui.style.height = (this.px * this.h - 2) + "px";
			this.refresh();
			this.loadControl();
		},
		
		refresh: function() {
			for (var i = 0; i < this.h; i++) {
				this.cell[i] = [];
				for (var j = 0; j < this.w; j++) {
					var posX = this.x + j;
					var posY = this.y + i;
					this.cell[i][j] = {x : posX, y : posY};
				}
			}
		},
		
		move: function(x, y) {
			this.x = x;
			this.y = y;
			this.refresh();
		},
		
		loadControl: function() {
			var dragobj = this.ui;
			var block = this;
			this.ui.onmousedown = function(event) {
				if (block.game.moveBlocked) {
					return;
				}
				dragobj.readyDrag = false;
				var boundaries = [];
				var offsetLeft = dragobj.offsetLeft;
				var offsetTop = dragobj.offsetTop;
				if (block.game.movable(block, 0)) {
					boundaries.push({
						direct: 0,
						vertical: dragobj.offsetTop - block.px,
						horizontal: 0
					});
				}
				if (block.game.movable(block, 1)) {
					boundaries.push({
						direct: 1,
						vertical: 0,
						horizontal: dragobj.offsetLeft + block.px
					});
				}
				if (block.game.movable(block, 2)) {
					boundaries.push({
						direct: 2,
						vertical: dragobj.offsetTop + block.px,
						horizontal: 0
					});
				}
				if (block.game.movable(block, 3)) {
					boundaries.push({
						direct: 3,
						vertical: 0,
						horizontal: dragobj.offsetLeft - block.px
					});
				}
				
				if (boundaries.length == 0) {
					dragobj.readyDrag = false;
				} else {
					dragobj.readyDrag = true;
				}
				
				if (!dragobj.readyDrag) {
					return;
				}
				dragobj.boundaries = boundaries;
				dragobj.startMouseX = event.clientX;
				dragobj.startMouseY = event.clientY;
				dragobj.mouseX = event.clientX;
				dragobj.mouseY = event.clientY;
				if (this.setCapture) {
					this.setCapture();
				} else if (window.captureEvents) {
					window.captureEvents(Event.MOUSEDOWN|Event.MOUSEMOVE|Event.MOUSEUP);
				}
			};
			
			this.ui.onmousemove = function(event) {
				if (!dragobj.readyDrag) {
					return;
				}
				var offsetStartX = event.clientX - dragobj.startMouseX;
				var offsetStartY = event.clientY - dragobj.startMouseY;
				var direct = -1;
				var offsetX = 0;
				var offsetY = 0;
				if (Math.abs(offsetStartX) >= Math.abs(offsetStartY)) {
					if (offsetStartX < 0) {
						direct = 3;	//left
					} else if (offsetStartX > 0) {
						direct = 1;	//right
					}
					offsetX = event.clientX - dragobj.mouseX;
				} else {
					if (offsetStartY < 0) {
						direct = 0;	//up
					} else if (offsetStartY > 0) {
						direct = 2;
					}
					offsetY = event.clientY - dragobj.mouseY;
				}
				
				var boundaries = dragobj.boundaries;
				var boundary = null;
				for (var i = 0; i < boundaries.length; i++) {
					if (boundaries[i].direct == direct) {
						boundary = boundaries[i];
					}
				}
				if (boundary == null) {
					return;
				}
				
				if (direct == 0) {
					dragobj.style.top = Math.max(dragobj.offsetTop + offsetY, boundary.vertical) + "px";
					dragobj.moveDirect = {x:0, y:-1};
				} else if (direct == 1) {
					dragobj.style.left = Math.min(dragobj.offsetLeft + offsetX, boundary.horizontal) + "px";
					dragobj.moveDirect = {x:1, y:0};
				} else if (direct == 2) {
					dragobj.style.top = Math.min(dragobj.offsetTop + offsetY, boundary.vertical) + "px";
					dragobj.moveDirect = {x:0, y:1};
				} else if (direct == 3) {
					dragobj.style.left = Math.max(dragobj.offsetLeft + offsetX, boundary.horizontal) + "px";
					dragobj.moveDirect = {x:-1, y:0};
				}
				
				dragobj.mouseX = event.clientX;
				dragobj.mouseY = event.clientY;
			};
			
			this.ui.onmouseup = function(event) {
				if (!dragobj.readyDrag) {
					return;
				}
				
				if (dragobj.moveDirect) {
					block.game.moveBlock(block, block.x + dragobj.moveDirect.x, block.y + dragobj.moveDirect.y);
				}
				
				if (this.releaseCapture) {
					this.releaseCapture();
				} else if (window.releaseEvents) {
					window.releaseEvents(Event.MOUSEDOWN|Event.MOUSEMOVE|Event.MOUSEUP);
				}
				dragobj.readyDrag = false;
				dragobj.moveDirect = null;
			};
			//TODO untested
			this.ui.onmouseout = function(event) {
				if (!dragobj.readyDrag) {
					return;
				}
				dragobj.readyDrag = false;
				dragobj.moveDirect = null;
				block.game.showBlock(block);
			}
		}
	}
	
	var Game = function(id) {
		this.WIDTH = 4;
		this.HEIGHT = 5;
		this.PIX = 100;
		
		this.gameUI = new GameUI(id);
		this.cells = [];
		this.blocks = [];
		this.moveBlocked = false;
		
		this.history = [];
		
		this.initialize();
	}
	
	Game.prototype = {
		initialize: function() {
			this.initCells();
			this.initBlocks();
			this.showBlocks();
		},
		
		initCells: function() {
			for (var i = 0; i < this.HEIGHT; i++) {
				this.cells[i] = [];
				for (var j = 0; j < this.WIDTH; j++) {
					this.cells[i][j] = 0;
				}
			}
		},
		
		initBlocks: function() {
			this.blocks.length = 0;
			this.blocks.push(new Block(2, 2, 1, 0, this));		//cao cao
			this.blocks.push(new Block(1, 2, 0, 0, this));
			this.blocks.push(new Block(1, 2, 3, 0, this));
			this.blocks.push(new Block(1, 2, 0, 2, this));
			this.blocks.push(new Block(2, 1, 1, 2, this));
			this.blocks.push(new Block(1, 1, 1, 3, this));
			this.blocks.push(new Block(1, 1, 2, 3, this));
			this.blocks.push(new Block(1, 2, 3, 2, this));
			this.blocks.push(new Block(1, 1, 0, 4, this));
			this.blocks.push(new Block(1, 1, 3, 4, this));
		},
		
		showBlocks: function() {
			for (var i = 0; i < this.blocks.length; i++) {
				this.showBlock(this.blocks[i]);
				this.updateCell(this.blocks[i], true);
			}
		},
		
		showBlock: function(block) {
			var pos = this.mapUIPosition(block.x, block.y);
			this.gameUI.show(block.ui, pos.x, pos.y);
		},
		
		mapUIPosition: function(x, y) {
			return {x: this.PIX * x, y: this.PIX * y};
		},
		
		moveBlock: function(block, x, y) {
			this.updateCell(block, false);
			block.move(x, y);
			this.showBlock(block);
			this.updateCell(block, true);
		},
		
		updateCell: function(block, b) {
			for (var i = 0; i < block.cell.length; i++) {
				for (var j = 0; j < block.cell[i].length; j++) {
					var bc = block.cell[i][j];
					this.cells[bc.y][bc.x] = b ? 1 : 0;
				}
			}
		},
		
		/*d - direct, 0-up, 1-right, 2-down, 3-left*/
		movable: function(block, d) {
			var b = true;
			if (d == 0) {
				for (var i = 0; i < block.cell[0].length; i++) {
					var c = block.cell[0][i];
					if (c.y == 0 || this.cells[c.y - 1][c.x] == 1) {
						b = false;
						break;
					}
				}
			} else if (d == 1) {
				var lastIndex = block.cell[0].length - 1;
				for (var i = 0; i < block.cell.length; i++) {
					var c = block.cell[i][lastIndex];
					if (c.x == this.WIDTH - 1 || this.cells[c.y][c.x + 1] == 1) {
						b = false;
						break;
					}
				}
			} else if (d == 2) {
				var lastIndex = block.cell.length - 1;
				for (var i = 0; i < block.cell[lastIndex].length; i++) {
					var c = block.cell[lastIndex][i];
					if (c.y == this.HEIGHT - 1 || this.cells[c.y + 1][c.x] == 1) {
						b = false;
						break;
					}
				}
			} else if (d == 3) {
				for (var i = 0; i < block.cell.length; i++) {
					var c = block.cell[i][0];
					if (c.x == 0 || this.cells[c.y][c.x - 1] == 1) {
						b = false;
						break;
					}
				}
			} else {
				b = false;
			}
			return b;
		}
	}
	
	window.onload = function() {
		var game = new Game('main');
	}
</script>
</head>
<body>
	<div id="main" class="mainboard"></div>
</body>
</html>