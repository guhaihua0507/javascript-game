<!DOCTYPE html>
<html>
<head>
<title>Snake</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link href="css/snake.css" rel="stylesheet" type="text/css">
<link href="css/keyboard.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="js/prototype.js"></script>
<script type="text/javascript">
	var SIZE;
	var PANEL_WIDTH;
	var PANEL_HEIGHT;
	function set()
	{
		SIZE=20;
		var panel=$('panel');
		PANEL_WIDTH=panel.clientWidth/SIZE;
		PANEL_HEIGHT=panel.clientHeight/SIZE;
	}
//-----------Food--------------------------------------------------
	var Food=function(x,y,panel){
		var body=document.createElement("div");
		body.className="food";
		this.div=body;
		this.xPos=x;
		this.yPos=y;
		panel.appendChild(body);
	}
	
	Food.prototype.setPosition=function(x,y)
	{
		this.xPos=x;
		this.yPos=y;
	}
	Food.prototype.draw=function()	
	{
		this.div.style.left=this.xPos*SIZE + "px";
		this.div.style.top=this.yPos*SIZE + "px";
	}
	Food.prototype.remove=function()
	{
		document.all.panel.removeChild(this.div);
	}
//------------Body-----------------------------------------------------
	var Body=function(x,y){
		var div=document.createElement("div");
		div.className="snake";
		this.view=div;
		this.xPos=x;
		this.yPos=y;
	}
	Body.prototype.move=function(x,y){
		this.xPos=x;
		this.yPos=y;
	}
	Body.prototype.getPosition=function()
	{
		return {x:this.xPos, y:this.yPos};
	}
	Body.prototype.updateView=function()
	{
		this.view.style.left=this.xPos*SIZE + "px";
		this.view.style.top=this.yPos*SIZE + "px";
	}
//-------------Snake----------------------------------------------------	
	var Snake=function(x,y,length,panel){
		this.bodys=new Array();
		this.movX=0;
		this.movY=0;
		this.moving=false;
		this.panel=panel;
		this.initialize(x,y,length);
	}
	Snake.prototype={			
		initialize: function(x,y,length){
			for(var i=0;i<length;i++)
			{
				this.addBody(new Body(x,y));
			}
			this.moving=true;
		},
		move: function(food){
			
			if(this.moving==false)
				return;
			var arr=this.bodys;
			
			var head=arr[0];
			var hpos=head.getPosition();
			
			var toX=hpos.x+this.movX;
			var toY=hpos.y+this.movY;
			if(this.die(toX,toY))
				return;

			head.move(toX,toY);
			if(head.xPos==food.xPos&&head.yPos==food.yPos)
				this.eat(food);
			var toPos=hpos;
			for(var i=1;i<arr.length;i++)
			{
				var pos=arr[i].getPosition();
				arr[i].move(toPos.x,toPos.y);
				toPos=pos;
			}
		},
		updateView: function(){
			this.bodys.each(function(b){
				b.updateView();
			})
		},
		eat: function(food){
			var x=food.xPos;
			var y=food.yPos;
			this.addBody(new Body(x,y));
			addFood();
		},
		addBody: function(body){
			this.panel.appendChild(body.view);
			this.bodys.push(body);
		},
		die: function(x,y){
			var bdie=(x<0||y<0||x>=PANEL_WIDTH||y>=PANEL_HEIGHT);
			if(bdie==true)
			{
				this.movX=0;
				this.movY=0;
				this.moving=false;
			}
			return bdie;
		}
	}
//-----------------------------------------------------------------
	function play()
	{
		if(snake.moving==false)
		{
			clearTimeout(mID);
			gameOver();
		}
		snake.move(food);
		snake.updateView();
	}
	function addFood()
	{
		var x=parseInt(Math.random()*PANEL_WIDTH);
		var y=parseInt(Math.random()*PANEL_HEIGHT);
		if(food==null)
		{
			var panel=$('panel');
			food=new Food(x,y,panel);
		}
		else
			food.setPosition(x,y);
		food.draw();
	}
	document.onkeyup=function(event)
	{
		if(snake.moving==false) {
			return;
		}
		var val = '';
		switch(event.keyCode) {
			case 37: val = 'left'; break;
			case 38: val = 'up'; break;
			case 39: val = 'right'; break;
			case 40: val = 'down'; break;
		}
		if (val != '') {
			control(val);
		}
	}
	function gameOver()
	{
		var message=document.createElement('div');
		message.className="dialog";
		message.innerHTML="GAME OVER";
		
		message.modalLayer=document.createElement('div');
		message.modalLayer.appendChild(message);
		message.modalLayer.className="modal";
		$('panel').appendChild(message.modalLayer);
	}
	
	function control(val) {
		if(snake.moving==false) {
			return;
		}
		if(val == 'left')
		{
			if(snake.movX==1)
				return;
			snake.movX=-1;
			snake.movY=0;
		}
		else if(val == 'up')
		{
			if(snake.movY==1)
				return;
			snake.movX=0;
			snake.movY=-1;
		}
		else if(val == 'right')
		{
			if(snake.movX==-1)
				return;
			snake.movX=1;
			snake.movY=0;
		}
		else if(val == 'down')
		{
			if(snake.movY==-1)
				return;
			snake.movX=0;
			snake.movY=1;
		}
	}
//--------------------------------------------	
	var snake=null;
	var food=null;
	var bstart=false;
	var mID;

	window.onload=function(){
		set();
		var panel=$('panel');

		snake=new Snake(10,10,3,panel);
		addFood();
		
		mID=setInterval('play()',100);
		
		if (navigator.userAgent.indexOf('Mobile') > -1) {
			loadVirtualKeyboard();
		}
	}
	
	var bindDrag = function(id) {
		var obj = document.getElementById(id);
		obj.readytomove = false;
		obj.onmousedown = function(event) {
			if (this.setCapture) {
				this.setCapture();
			} else if (window.captureEvents) {
				window.captureEvents(Event.MOUSEDOWN|Event.MOUSEMOVE|Event.MOUSEUP);
			}
			this.readytomove = true;
			var offsetPos = {left: obj.offsetLeft, right: obj.offsetTop};
			this.mouseX = event.clientX;
			this.mouseY = event.clientY;
		};

		obj.onmousemove = function(event) {
			if (this.readytomove == false) {
				return;
			}
			this.style.left = (event.clientX - this.mouseX + this.offsetLeft) + "px";
			this.style.top = (event.clientY - this.mouseY + this.offsetTop) + "px";
			this.mouseX = event.clientX;
			this.mouseY = event.clientY;
		};

		obj.onmouseup = function(event) {
			if (this.readytomove == true) {
				if (this.releaseCapture) {
					this.releaseCapture()
				} else if (window.releaseEvents) {
					window.releaseEvents(Event.MOUSEDOWN|Event.MOUSEMOVE|Event.MOUSEUP);
				}
				this.readytomove = false;
			}
		}
	}
	
	function loadVirtualKeyboard() {
		var keyboard = document.getElementById('vKeyboard');
		keyboard.style.display = '';
		var width = keyboard.offsetWidth;
		var height = keyboard.offsetHeight;
		var panel = $('panel');
		keyboard.style.left = (panel.offsetLeft + panel.offsetWidth) + "px";
		keyboard.style.top = (panel.offsetTop + panel.offsetHeight - height) / 2 + "px";
		
		bindDrag('vKeyboard');
	}
</script>
</head>
<body>
	<div class='panel' id='panel'></div>
	<div id='vKeyboard' class="keyboard" style="display: none;">
		<div class="keyline" onclick="control('up')">
			<div class="key up"></div>
		</div>
		<div class="keyline">
			<div class="key left" onclick="control('left')"></div>
			<div class="key right" onclick="control('right')"></div>
		</div>
		<div class="keyline">
			<div class="key down" onclick="control('down')"></div>
		</div>
	</div>
</body>
</html>